<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹³é¢åœ–äº‹ä»¶ç´€éŒ„ç³»çµ±</title>
    <!-- å¼•å…¥ Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ FontAwesome åœ–ç¤ºåº« -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Fabric.js (è™•ç† Canvas) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    
    <style>
        body { background-color: #f4f6f9; height: 100vh; overflow: hidden; }
        .main-container { height: 100%; display: flex; }
        .sidebar { width: 350px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; padding: 15px; overflow-y: auto; }
        .canvas-area { flex-grow: 1; background: #e9ecef; position: relative; display: flex; justify-content: center; align-items: center; overflow: auto; }
        
        .component-item {
            cursor: grab;
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            border-radius: 5px;
            background: #fff;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }
        .component-item:hover { background: #f8f9fa; border-color: #0d6efd; }
        .component-item i { font-size: 20px; margin-right: 10px; width: 30px; text-align: center; }
        
        #canvas-wrapper { 
            box-shadow: 0 0 20px rgba(0,0,0,0.1); 
            background: white; 
        }

        .log-item { font-size: 0.9rem; border-bottom: 1px solid #eee; padding: 8px 0; }
        .log-time { color: #888; font-size: 0.8rem; }
        
        /* æ‹–æ›³æ™‚çš„æ¨£å¼ */
        .dragging { opacity: 0.5; }
    </style>
</head>
<body>

<div class="main-container">
    <!-- å·¦å´èˆ‡å·¥å…·åˆ— (ä¾ç…§éœ€æ±‚æ”¹ç‚ºå³å´é‚è¼¯ï¼Œä½†ç‚ºäº†ç‰ˆé¢é€šå¸¸å·¦å´æ”¾å·¥å…·è¼ƒé †æ‰‹ï¼Œé€™è£¡å°‡å·¥å…·æ”¾å·¦å´ï¼Œå¹³é¢åœ–æ”¾å³å´ï¼Œæˆ–ä¾æ‚¨éœ€æ±‚èª¿æ•´) -->
    <!-- é€™è£¡ä¾ç…§æ‚¨çš„æè¿°ï¼šå·¦å´å°å…¥åœ–ï¼Œå³å´ç·¨è¼¯ã€‚ä½†é€šå¸¸æ“ä½œé¢æ¿åœ¨å´é‚Šã€‚ä»¥ä¸‹é…ç½®ï¼šå·¦å´æ˜¯å¤§å¹³é¢åœ–ï¼Œå³å´æ˜¯æ“ä½œé¢æ¿ -->
    
    <!-- å·¦å´ï¼šå¹³é¢åœ–å€åŸŸ -->
    <div class="canvas-area" id="drop-area">
        <div id="canvas-wrapper">
            <canvas id="c" width="800" height="600"></canvas>
        </div>
        <div class="position-absolute top-0 start-0 m-3">
            <label class="btn btn-primary shadow">
                <i class="fas fa-image me-2"></i>åŒ¯å…¥å¹³é¢åœ–
                <input type="file" id="imgLoader" style="display: none;" accept="image/*">
            </label>
            <button class="btn btn-success shadow ms-2" onclick="saveSystem()">
                <i class="fas fa-save me-2"></i>å¦å­˜ç¶²é  (å«ç´€éŒ„)
            </button>
        </div>
    </div>

    <!-- å³å´ï¼šæ§åˆ¶èˆ‡ç´€éŒ„é¢æ¿ -->
    <div class="sidebar shadow-sm">
        <h5 class="border-bottom pb-2"><i class="fas fa-tools me-2"></i>å·¥å…·ç®±</h5>
        
        <!-- æœå°‹åŠŸèƒ½ -->
        <div class="input-group mb-3">
            <input type="text" id="searchInput" class="form-control" placeholder="æœå°‹é—œéµå­— (å¦‚: æ¼æ°´)...">
            <button class="btn btn-outline-secondary" type="button" onclick="searchEvents()"><i class="fas fa-search"></i></button>
        </div>

        <!-- é ç±¤ -->
        <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="components-tab" data-bs-toggle="tab" data-bs-target="#components" type="button">çµ„ä»¶åº«</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="custom-tab" data-bs-toggle="tab" data-bs-target="#custom" type="button">è‡ªå®šç¾©</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button">ç´€éŒ„</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- é è¨­çµ„ä»¶ -->
            <div class="tab-pane fade show active" id="components">
                <div class="d-grid gap-2">
                    <div class="component-item" draggable="true" ondragstart="dragStart(event)" data-type="icon" data-icon="fa-snowflake" data-color="#0dcaf0" data-label="å†·æ°£æ©Ÿ">
                        <i class="fas fa-snowflake text-info"></i> å†·æ°£æ©Ÿ
                    </div>
                    <div class="component-item" draggable="true" ondragstart="dragStart(event)" data-type="icon" data-icon="fa-wind" data-color="#6c757d" data-label="é™¤æ¿•æ©Ÿ">
                        <i class="fas fa-wind text-secondary"></i> é™¤æ¿•æ©Ÿ
                    </div>
                    <div class="component-item" draggable="true" ondragstart="dragStart(event)" data-type="icon" data-icon="fa-droplet" data-color="#0d6efd" data-label="æ¼æ°´é»">
                        <i class="fas fa-droplet text-primary"></i> æ¼æ°´ç™¼ç”Ÿé»
                    </div>
                    <div class="component-item" draggable="true" ondragstart="dragStart(event)" data-type="icon" data-icon="fa-bug" data-color="#dc3545" data-label="é¼ æ‚£/èŸ²å®³">
                        <i class="fas fa-bug text-danger"></i> é¼ æ‚£/èŸ²å®³ç´€éŒ„
                    </div>
                    <div class="component-item" draggable="true" ondragstart="dragStart(event)" data-type="icon" data-icon="fa-triangle-exclamation" data-color="#ffc107" data-label="æ³¨æ„å€åŸŸ">
                        <i class="fas fa-triangle-exclamation text-warning"></i> è­¦å‘Š/æ³¨æ„å€åŸŸ
                    </div>
                </div>
                <small class="text-muted mt-2 d-block">* æ‹–æ›³çµ„ä»¶è‡³å·¦å´å¹³é¢åœ–</small>
            </div>

            <!-- è‡ªå®šç¾©çµ„ä»¶ -->
            <div class="tab-pane fade" id="custom">
                <div class="mb-3">
                    <label class="form-label">äº‹ä»¶åç¨±/æ¨™ç±¤</label>
                    <input type="text" class="form-control" id="customLabel" placeholder="ä¾‹å¦‚ï¼š202æœƒè­°å®¤ç‰†å£è£‚ç—•">
                </div>
                <div class="mb-3">
                    <label class="form-label">é¸æ“‡åœ–ç¤º</label>
                    <select class="form-select" id="customIcon">
                        <option value="fa-circle-exclamation">â— é©šå˜†è™Ÿ</option>
                        <option value="fa-wrench">ğŸ”§ ç¶­ä¿®</option>
                        <option value="fa-fire">ğŸ”¥ ç«æº</option>
                        <option value="fa-camera">ğŸ“· ç›£è¦–å™¨</option>
                        <option value="fa-comment-dots">ğŸ’¬ æ–‡å­—è¨»è¨˜</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">é¡è‰²</label>
                    <input type="color" class="form-control form-control-color" id="customColor" value="#ff0000">
                </div>
                <button class="btn btn-dark w-100" onclick="addCustomComponent()">æ–°å¢è‡³ç•«é¢</button>
            </div>

            <!-- ç·¨è¼¯ç´€éŒ„ -->
            <div class="tab-pane fade" id="logs">
                <div id="logList">
                    <p class="text-muted text-center mt-3">æš«ç„¡ç·¨è¼¯ç´€éŒ„</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç”¨æ–¼å„²å­˜è³‡æ–™çš„éš±è—å€å¡Š (JSON) -->
<script id="saved-data" type="application/json"></script>

<script>
    // åˆå§‹åŒ– Fabric Canvas
    const canvas = new fabric.Canvas('c');
    let logData = []; // å„²å­˜æ­·å²ç´€éŒ„

    // 1. è™•ç†å¹³é¢åœ–åŒ¯å…¥ (è½‰ç‚º Base64 ä»¥ä¾¿å­˜æª”)
    document.getElementById('imgLoader').addEventListener('change', function (e) {
        const reader = new FileReader();
        reader.onload = function (event) {
            const imgObj = new Image();
            imgObj.src = event.target.result;
            imgObj.onload = function () {
                const imgInstance = new fabric.Image(imgObj);
                // èª¿æ•´ç•«å¸ƒå¤§å°é©æ‡‰åœ–ç‰‡ (æœ€å¤§é™åˆ¶)
                const maxWidth = document.querySelector('.canvas-area').clientWidth - 50;
                const scale = maxWidth / imgInstance.width;
                
                if (imgInstance.width > maxWidth) {
                    imgInstance.scale(scale);
                    canvas.setWidth(imgInstance.width * scale);
                    canvas.setHeight(imgInstance.height * scale);
                } else {
                    canvas.setWidth(imgInstance.width);
                    canvas.setHeight(imgInstance.height);
                }
                
                canvas.setBackgroundImage(imgInstance, canvas.renderAll.bind(canvas), {
                   scaleX: imgInstance.width > maxWidth ? scale : 1,
                   scaleY: imgInstance.width > maxWidth ? scale : 1
                });
                
                addLog("ç³»çµ±", "å·²åŒ¯å…¥å¹³é¢åœ–");
            }
        }
        reader.readAsDataURL(e.target.files[0]);
    });

    // 2. æ‹–æ›³åŠŸèƒ½å¯¦ä½œ
    function dragStart(e) {
        e.dataTransfer.setData('icon', e.target.dataset.icon);
        e.dataTransfer.setData('color', e.target.dataset.color);
        e.dataTransfer.setData('label', e.target.dataset.label);
    }

    const dropArea = document.getElementById('drop-area');
    dropArea.addEventListener('dragover', (e) => { e.preventDefault(); });
    dropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        const iconClass = e.dataTransfer.getData('icon');
        const color = e.dataTransfer.getData('color');
        const label = e.dataTransfer.getData('label');

        if (iconClass) {
            // å–å¾—æ»‘é¼ ç›¸å°æ–¼ Canvas çš„åº§æ¨™
            const pointer = canvas.getPointer(e);
            addComponentToCanvas(iconClass, color, label, pointer.x, pointer.y);
        }
    });

    // å°‡çµ„ä»¶åŠ åˆ° Canvas çš„æ ¸å¿ƒå‡½å¼
    function addComponentToCanvas(iconClass, color, labelText, left, top) {
        // ä½¿ç”¨ FontAwesome çš„ Unicode (éœ€è¦çŸ¥é“å°æ‡‰ç¢¼ï¼Œé€™è£¡ç°¡åŒ–ä½¿ç”¨ Text æ›¿ä»£æˆ–éœ€æŸ¥è©¢è¡¨)
        // ç‚ºäº†é€šç”¨æ€§ï¼Œæˆ‘å€‘å»ºç«‹ä¸€å€‹åŒ…å«æ–‡å­—å’Œåœ“åœˆçš„ç¾¤çµ„
        
        // å–å¾— FontAwesome çš„ unicode (ç°¡åŒ–è™•ç†ï¼šç”¨ HTML å…ƒç´ å–å¾—å…§å®¹å¾Œç¹ªè£½ï¼Œæˆ–ç›´æ¥ç”¨æ–‡å­—)
        // é€™è£¡æ¡ç”¨ Fabric Text é¡¯ç¤ºåœ–ç¤º (éœ€ç¢ºä¿å­—å‹è¼‰å…¥)
        // ç‚ºäº†ç°¡å–®ä¸”è·¨ç€è¦½å™¨ï¼Œæˆ‘å€‘ç”¨åœ“å½¢+æ–‡å­—æ¨™ç±¤ä»£è¡¨
        
        const circle = new fabric.Circle({
            radius: 15,
            fill: color,
            originX: 'center', originY: 'center',
            stroke: 'white', strokeWidth: 2
        });

        const text = new fabric.Text(labelText, {
            fontSize: 14,
            originX: 'center', originY: 'top',
            top: 20,
            fill: '#333',
            fontFamily: 'Microsoft JhengHei'
        });

        // å»ºç«‹ç¾¤çµ„
        const group = new fabric.Group([circle, text], {
            left: left,
            top: top,
            hasBorders: true,
            hasControls: true
        });
        
        // åŠ å…¥è‡ªå®šç¾©å±¬æ€§ä¾›æœå°‹ç”¨
        group.customLabel = labelText;
        group.customType = iconClass;
        group.timestamp = new Date().toLocaleString();

        canvas.add(group);
        canvas.setActiveObject(group);
        
        addLog("æ–°å¢", `æ·»åŠ äº† [${labelText}]`);
    }

    // 3. è‡ªå®šç¾©çµ„ä»¶æ–°å¢
    function addCustomComponent() {
        const label = document.getElementById('customLabel').value || "è‡ªå®šç¾©æ¨™è¨˜";
        const icon = document.getElementById('customIcon').value;
        const color = document.getElementById('customColor').value;
        
        // é è¨­æ”¾åœ¨ç•«å¸ƒä¸­é–“
        addComponentToCanvas(icon, color, label, canvas.width / 2, canvas.height / 2);
    }

    // 4. ç´€éŒ„ç³»çµ±
    function addLog(action, desc) {
        const time = new Date().toLocaleString();
        logData.push({ time, action, desc });
        renderLogs();
    }

    function renderLogs(filterText = "") {
        const list = document.getElementById('logList');
        list.innerHTML = "";
        
        const filtered = logData.filter(log => 
            filterText === "" || log.desc.includes(filterText)
        );

        if(filtered.length === 0) {
            list.innerHTML = '<p class="text-muted text-center mt-3">ç„¡ç›¸é—œç´€éŒ„</p>';
            return;
        }

        // åè½‰é¡¯ç¤ºï¼Œæœ€æ–°çš„åœ¨ä¸Šé¢
        [...filtered].reverse().forEach(log => {
            const item = document.createElement('div');
            item.className = 'log-item';
            item.innerHTML = `
                <div class="d-flex justify-content-between">
                    <strong>${log.action}</strong>
                    <span class="log-time">${log.time}</span>
                </div>
                <div>${log.desc}</div>
            `;
            list.appendChild(item);
        });
    }

    // 5. æœå°‹èˆ‡é€£è²«é¡¯ç¤ºåŠŸèƒ½
    function searchEvents() {
        const keyword = document.getElementById('searchInput').value.trim();
        
        // 1. æœå°‹ Canvas ç‰©ä»¶ä¸¦é«˜äº®
        const objects = canvas.getObjects();
        
        canvas.discardActiveObject(); // å–æ¶ˆç•¶å‰é¸å–
        
        if (keyword === "") {
            // æ¸…é™¤æœå°‹ç‹€æ…‹ (é‚„åŸé€æ˜åº¦)
            objects.forEach(obj => {
                obj.set('opacity', 1);
                // é‚„åŸå¤–æ¡†
                if(obj.item(0)) obj.item(0).set('stroke', 'white'); 
            });
        } else {
            // åŸ·è¡Œæœå°‹
            const sel = new fabric.ActiveSelection([], { canvas: canvas });
            
            objects.forEach(obj => {
                // æª¢æŸ¥ label æ˜¯å¦åŒ…å«é—œéµå­—
                if (obj.customLabel && obj.customLabel.includes(keyword)) {
                    obj.set('opacity', 1);
                    // é«˜äº®é¡¯ç¤º (æŠŠåœ“åœˆè®Šç²—æ¡†)
                    if(obj.item(0)) obj.item(0).set('stroke', 'red'); 
                    if(obj.item(0)) obj.item(0).set('strokeWidth', 4);
                } else {
                    // éæœå°‹çµæœè®Šæ·¡
                    obj.set('opacity', 0.2);
                    if(obj.item(0)) obj.item(0).set('stroke', 'white');
                    if(obj.item(0)) obj.item(0).set('strokeWidth', 2);
                }
            });
        }
        canvas.requestRenderAll();
        
        // 2. éæ¿¾å³å´ç´€éŒ„
        renderLogs(keyword);
    }
    
    // ç›£è½éµç›¤ Enter æœå°‹
    document.getElementById('searchInput').addEventListener('keyup', function(e){
        if(e.key === 'Enter') searchEvents();
    });

    // 6. ç›£è½ç‰©ä»¶ä¿®æ”¹äº‹ä»¶ (ç§»å‹•ã€åˆªé™¤)
    canvas.on('object:modified', function(e) {
        const obj = e.target;
        addLog("ç§»å‹•", `èª¿æ•´äº† [${obj.customLabel}] çš„ä½ç½®`);
    });

    // åˆªé™¤åŠŸèƒ½ (æŒ‰ Delete éµ)
    window.addEventListener('keydown', function(e) {
        if (e.key === 'Delete' || e.key === 'Backspace') {
            const activeObjects = canvas.getActiveObjects();
            if (activeObjects.length) {
                canvas.discardActiveObject();
                activeObjects.forEach(function(obj) {
                    canvas.remove(obj);
                    addLog("åˆªé™¤", `ç§»é™¤äº† [${obj.customLabel}]`);
                });
            }
        }
    });

    // ==========================================
    // 7. å¦å­˜ç¶²é æ ¸å¿ƒé‚è¼¯ (Quine: Self-replicating)
    // ==========================================
    function saveSystem() {
        // 1. å–å¾—ç•¶å‰ Canvas ç‹€æ…‹ (åŒ…å«èƒŒæ™¯åœ– Base64)
        const canvasJson = JSON.stringify(canvas.toJSON(['customLabel', 'customType', 'timestamp']));
        
        // 2. æº–å‚™è¦å„²å­˜çš„è³‡æ–™ç‰©ä»¶
        const saveData = {
            canvas: canvasJson,
            logs: logData
        };

        // 3. è®€å–ç•¶å‰ HTML åŸå§‹ç¢¼
        let htmlContent = document.documentElement.outerHTML;

        // 4. å°‡è³‡æ–™æ³¨å…¥åˆ° <script id="saved-data"> æ¨™ç±¤ä¸­
        // æˆ‘å€‘ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æˆ–å­—ä¸²æ›¿æ›ä¾†æ›´æ–°è©²å€å¡Šçš„å…§å®¹
        const dataScriptPattern = /<script id="saved-data" type="application\/json">([\s\S]*?)<\/script>/;
        const newDataScript = `<script id="saved-data" type="application/json">${JSON.stringify(saveData)}<\/script>`;
        
        htmlContent = htmlContent.replace(dataScriptPattern, newDataScript);

        // 5. å»ºç«‹ Blob ä¸¦ä¸‹è¼‰
        const blob = new Blob([htmlContent], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `å¹³é¢åœ–ç´€éŒ„_${new Date().toISOString().slice(0,10)}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        addLog("ç³»çµ±", "å·²åŒ¯å‡ºç¶²é æª”æ¡ˆ");
    }

    // ==========================================
    // 8. ç¶²é è¼‰å…¥æ™‚çš„è³‡æ–™å¾©åŸ (å¦‚æœæœ‰å­˜æª”è³‡æ–™)
    // ==========================================
    window.onload = function() {
        const dataScript = document.getElementById('saved-data');
        if (dataScript && dataScript.textContent.trim() !== "") {
            try {
                const savedData = JSON.parse(dataScript.textContent);
                
                // å¾©åŸç´€éŒ„
                if(savedData.logs) {
                    logData = savedData.logs;
                    renderLogs();
                }

                // å¾©åŸ Canvas
                if(savedData.canvas) {
                    canvas.loadFromJSON(savedData.canvas, function() {
                        canvas.renderAll();
                        addLog("ç³»çµ±", "å·²æˆåŠŸè®€å–èˆŠæª”ç´€éŒ„");
                    });
                }
            } catch (e) {
                console.error("è®€å–å­˜æª”å¤±æ•—", e);
            }
        }
    };

</script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>