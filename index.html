<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹³é¢åœ–äº‹ä»¶ç´€éŒ„ç³»çµ± (å«å‚™è¨»åŠŸèƒ½)</title>
    <!-- å¼•å…¥ Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ FontAwesome åœ–ç¤ºåº« -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Fabric.js (è™•ç† Canvas) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    
    <style>
        body { background-color: #f4f6f9; height: 100vh; overflow: hidden; font-family: "Microsoft JhengHei", sans-serif; }
        .main-container { height: 100%; display: flex; }
        .sidebar { width: 380px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; padding: 15px; overflow-y: auto; }
        .canvas-area { flex-grow: 1; background: #e9ecef; position: relative; display: flex; justify-content: center; align-items: center; overflow: auto; }
        
        .component-item {
            cursor: grab;
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            border-radius: 5px;
            background: #fff;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }
        .component-item:hover { background: #f8f9fa; border-color: #0d6efd; transform: translateX(5px); }
        .component-item i { font-size: 20px; margin-right: 10px; width: 30px; text-align: center; }
        
        #canvas-wrapper { 
            box-shadow: 0 0 20px rgba(0,0,0,0.1); 
            background: white; 
        }

        .log-item { font-size: 0.9rem; border-bottom: 1px solid #eee; padding: 8px 0; }
        .log-time { color: #888; font-size: 0.8rem; }
        
        /* é¸å–ç·¨è¼¯å€å¡Šæ¨£å¼ */
        #edit-panel {
            background-color: #fff3cd;
            border: 1px solid #ffecb5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none; /* é è¨­éš±è— */
        }
    </style>
</head>
<body>

<div class="main-container">
    
    <!-- å·¦å´ï¼šå¹³é¢åœ–å€åŸŸ -->
    <div class="canvas-area" id="drop-area">
        <div id="canvas-wrapper">
            <canvas id="c" width="800" height="600"></canvas>
        </div>
        <div class="position-absolute top-0 start-0 m-3">
            <label class="btn btn-primary shadow">
                <i class="fas fa-image me-2"></i>åŒ¯å…¥å¹³é¢åœ–
                <input type="file" id="imgLoader" style="display: none;" accept="image/*">
            </label>
            <button class="btn btn-success shadow ms-2" onclick="saveSystem()">
                <i class="fas fa-save me-2"></i>å¦å­˜ç¶²é  (å«ç´€éŒ„)
            </button>
        </div>
    </div>

    <!-- å³å´ï¼šæ§åˆ¶èˆ‡ç´€éŒ„é¢æ¿ -->
    <div class="sidebar shadow-sm">
        <h5 class="border-bottom pb-2"><i class="fas fa-tools me-2"></i>æ“ä½œé¢æ¿</h5>
        
        <!-- å‹•æ…‹ç·¨è¼¯å€ï¼šåªæœ‰é¸å–ç‰©ä»¶æ™‚æœƒå‡ºç¾ -->
        <div id="edit-panel" class="shadow-sm">
            <h6 class="text-warning-emphasis fw-bold"><i class="fas fa-pen-to-square"></i> ç·¨è¼¯é¸å–é …ç›®</h6>
            <div class="mb-2">
                <label class="form-label mb-1">åç¨±/æ¨™ç±¤</label>
                <input type="text" class="form-control form-control-sm" id="editLabelInput">
            </div>
            <div class="mb-2">
                <label class="form-label mb-1">è©³ç´°å‚™è¨»</label>
                <textarea class="form-control form-control-sm" id="editNoteInput" rows="3" placeholder="è«‹è¼¸å…¥å‚™è¨»..."></textarea>
            </div>
            <div class="d-flex justify-content-between">
                <button class="btn btn-sm btn-outline-danger" onclick="deleteActiveObject()">åˆªé™¤ç‰©ä»¶</button>
                <button class="btn btn-sm btn-dark" onclick="updateActiveObject()">æ›´æ–°è³‡æ–™</button>
            </div>
        </div>

        <!-- æœå°‹åŠŸèƒ½ -->
        <div class="input-group mb-3">
            <input type="text" id="searchInput" class="form-control" placeholder="æœå°‹åç¨±æˆ–å‚™è¨»...">
            <button class="btn btn-outline-secondary" type="button" onclick="searchEvents()"><i class="fas fa-search"></i></button>
        </div>

        <!-- é ç±¤ -->
        <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="components-tab" data-bs-toggle="tab" data-bs-target="#components" type="button">çµ„ä»¶åº«</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="custom-tab" data-bs-toggle="tab" data-bs-target="#custom" type="button">è‡ªå®šç¾©</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button">ç´€éŒ„</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- é è¨­çµ„ä»¶ -->
            <div class="tab-pane fade show active" id="components">
                <div class="d-grid gap-2">
                    <div class="component-item" draggable="true" ondragstart="dragStart(event)" data-type="icon" data-icon="fa-snowflake" data-color="#0dcaf0" data-label="å†·æ°£æ©Ÿ">
                        <i class="fas fa-snowflake text-info"></i> å†·æ°£æ©Ÿ
                    </div>
                    <div class="component-item" draggable="true" ondragstart="dragStart(event)" data-type="icon" data-icon="fa-wind" data-color="#6c757d" data-label="é™¤æ¿•æ©Ÿ">
                        <i class="fas fa-wind text-secondary"></i> é™¤æ¿•æ©Ÿ
                    </div>
                    <div class="component-item" draggable="true" ondragstart="dragStart(event)" data-type="icon" data-icon="fa-droplet" data-color="#0d6efd" data-label="æ¼æ°´é»">
                        <i class="fas fa-droplet text-primary"></i> æ¼æ°´ç™¼ç”Ÿé»
                    </div>
                    <div class="component-item" draggable="true" ondragstart="dragStart(event)" data-type="icon" data-icon="fa-bug" data-color="#dc3545" data-label="é¼ æ‚£/èŸ²å®³">
                        <i class="fas fa-bug text-danger"></i> é¼ æ‚£/èŸ²å®³ç´€éŒ„
                    </div>
                    <div class="component-item" draggable="true" ondragstart="dragStart(event)" data-type="icon" data-icon="fa-triangle-exclamation" data-color="#ffc107" data-label="æ³¨æ„å€åŸŸ">
                        <i class="fas fa-triangle-exclamation text-warning"></i> è­¦å‘Š/æ³¨æ„å€åŸŸ
                    </div>
                </div>
                <div class="alert alert-light mt-3 border">
                    <small class="text-muted"><i class="fas fa-info-circle"></i> æ‹–æ›³çµ„ä»¶è‡³åœ–ä¸Šå¾Œï¼Œé»æ“Šè©²çµ„ä»¶å³å¯ç·¨è¼¯è©³ç´°å‚™è¨»ã€‚</small>
                </div>
            </div>

            <!-- è‡ªå®šç¾©çµ„ä»¶ -->
            <div class="tab-pane fade" id="custom">
                <div class="mb-2">
                    <label class="form-label">äº‹ä»¶åç¨±</label>
                    <input type="text" class="form-control" id="customLabel" placeholder="ä¾‹å¦‚ï¼š202æœƒè­°å®¤">
                </div>
                <div class="mb-2">
                    <label class="form-label">é¸æ“‡åœ–ç¤º</label>
                    <select class="form-select" id="customIcon">
                        <option value="fa-circle-exclamation">â— é©šå˜†è™Ÿ</option>
                        <option value="fa-wrench">ğŸ”§ ç¶­ä¿®</option>
                        <option value="fa-fire">ğŸ”¥ ç«æº</option>
                        <option value="fa-camera">ğŸ“· ç›£è¦–å™¨</option>
                        <option value="fa-comment-dots">ğŸ’¬ æ–‡å­—è¨»è¨˜</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label">é¡è‰²</label>
                    <input type="color" class="form-control form-control-color w-100" id="customColor" value="#ff0000">
                </div>
                <div class="mb-3">
                    <label class="form-label">é è¨­å‚™è¨»</label>
                    <textarea class="form-control" id="customNote" rows="2" placeholder="å¯åœ¨æ­¤å…ˆè¼¸å…¥å‚™è¨»å…§å®¹"></textarea>
                </div>
                <button class="btn btn-dark w-100" onclick="addCustomComponent()">æ–°å¢è‡³ç•«é¢</button>
            </div>

            <!-- ç·¨è¼¯ç´€éŒ„ -->
            <div class="tab-pane fade" id="logs">
                <div id="logList">
                    <p class="text-muted text-center mt-3">æš«ç„¡ç·¨è¼¯ç´€éŒ„</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç”¨æ–¼å„²å­˜è³‡æ–™çš„éš±è—å€å¡Š (JSON) -->
<script id="saved-data" type="application/json"></script>

<script>
    // åˆå§‹åŒ– Fabric Canvas
    const canvas = new fabric.Canvas('c');
    let logData = []; // å„²å­˜æ­·å²ç´€éŒ„

    // ==========================================
    // 1. æ ¸å¿ƒé‚è¼¯ï¼šæ–°å¢ç‰©ä»¶åˆ°ç•«å¸ƒ
    // ==========================================
    function addComponentToCanvas(iconClass, color, labelText, left, top, noteContent = "") {
        // åœ“åœˆèƒŒæ™¯
        const circle = new fabric.Circle({
            radius: 15,
            fill: color,
            originX: 'center', originY: 'center',
            stroke: 'white', strokeWidth: 2
        });

        // æ–‡å­—æ¨™ç±¤
        const text = new fabric.Text(labelText, {
            fontSize: 14,
            originX: 'center', originY: 'top',
            top: 20,
            fill: '#333',
            fontFamily: 'Microsoft JhengHei'
        });

        // å»ºç«‹ç¾¤çµ„
        const group = new fabric.Group([circle, text], {
            left: left,
            top: top,
            hasBorders: true,
            hasControls: true
        });
        
        // **é—œéµï¼šç¶å®šè‡ªå®šç¾©å±¬æ€§**
        group.customLabel = labelText;
        group.customType = iconClass;
        group.customNote = noteContent; // å„²å­˜å‚™è¨»
        group.timestamp = new Date().toLocaleString();

        canvas.add(group);
        canvas.setActiveObject(group);
        
        let logMsg = `æ·»åŠ äº† [${labelText}]`;
        if(noteContent) logMsg += ` (å‚™è¨»: ${noteContent})`;
        addLog("æ–°å¢", logMsg);
    }

    // ==========================================
    // 2. æ‹–æ›³åŠŸèƒ½
    // ==========================================
    function dragStart(e) {
        e.dataTransfer.setData('icon', e.target.dataset.icon);
        e.dataTransfer.setData('color', e.target.dataset.color);
        e.dataTransfer.setData('label', e.target.dataset.label);
    }

    const dropArea = document.getElementById('drop-area');
    dropArea.addEventListener('dragover', (e) => { e.preventDefault(); });
    dropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        const iconClass = e.dataTransfer.getData('icon');
        const color = e.dataTransfer.getData('color');
        const label = e.dataTransfer.getData('label');

        if (iconClass) {
            const pointer = canvas.getPointer(e);
            addComponentToCanvas(iconClass, color, label, pointer.x, pointer.y);
        }
    });

    // ==========================================
    // 3. è‡ªå®šç¾©çµ„ä»¶æ–°å¢
    // ==========================================
    function addCustomComponent() {
        const label = document.getElementById('customLabel').value || "è‡ªå®šç¾©æ¨™è¨˜";
        const icon = document.getElementById('customIcon').value;
        const color = document.getElementById('customColor').value;
        const note = document.getElementById('customNote').value; // å–å¾—é è¨­å‚™è¨»
        
        addComponentToCanvas(icon, color, label, canvas.width / 2, canvas.height / 2, note);
        
        // æ¸…ç©ºè¼¸å…¥æ¡†
        document.getElementById('customLabel').value = "";
        document.getElementById('customNote').value = "";
    }

    // ==========================================
    // 4. é¸å–ç‰©ä»¶å¾Œçš„ç·¨è¼¯é‚è¼¯ (æ–°å¢éƒ¨åˆ†)
    // ==========================================
    const editPanel = document.getElementById('edit-panel');
    const editLabelInput = document.getElementById('editLabelInput');
    const editNoteInput = document.getElementById('editNoteInput');

    // ç•¶ç‰©ä»¶è¢«é¸å–æ™‚
    function onSelectionCreated() {
        const activeObj = canvas.getActiveObject();
        if (activeObj && activeObj.type === 'group') {
            // å°‡è³‡æ–™å¸¶å…¥ç·¨è¼¯æ¡†
            editLabelInput.value = activeObj.customLabel || "";
            editNoteInput.value = activeObj.customNote || "";
            editPanel.style.display = 'block'; // é¡¯ç¤ºç·¨è¼¯å€
        }
    }

    // ç•¶é¸å–å–æ¶ˆæ™‚
    function onSelectionCleared() {
        editPanel.style.display = 'none'; // éš±è—ç·¨è¼¯å€
    }

    canvas.on('selection:created', onSelectionCreated);
    canvas.on('selection:updated', onSelectionCreated);
    canvas.on('selection:cleared', onSelectionCleared);

    // æ›´æ–°ç‰©ä»¶è³‡æ–™æŒ‰éˆ•
    function updateActiveObject() {
        const activeObj = canvas.getActiveObject();
        if (activeObj) {
            const oldLabel = activeObj.customLabel;
            const newLabel = editLabelInput.value;
            const newNote = editNoteInput.value;

            // æ›´æ–°å±¬æ€§
            activeObj.customLabel = newLabel;
            activeObj.customNote = newNote;

            // æ›´æ–°ç•«å¸ƒä¸Šçš„æ–‡å­—é¡¯ç¤º (ç¾¤çµ„ä¸­çš„ç¬¬äºŒå€‹ç‰©ä»¶æ˜¯æ–‡å­—)
            // item(1) æ˜¯æ–‡å­—ç‰©ä»¶
            if (activeObj.item(1)) {
                activeObj.item(1).set('text', newLabel);
            }

            canvas.requestRenderAll();
            addLog("æ›´æ–°", `æ›´æ–°äº† [${oldLabel}] çš„è³‡æ–™ (å‚™è¨»: ${newNote})`);
            
            // çŸ­æš«æç¤ºæ›´æ–°æˆåŠŸ (å¯é¸)
            alert("æ›´æ–°æˆåŠŸï¼");
        }
    }

    // åˆªé™¤ç‰©ä»¶æŒ‰éˆ•
    function deleteActiveObject() {
        const activeObj = canvas.getActiveObject();
        if (activeObj) {
            canvas.remove(activeObj);
            canvas.discardActiveObject();
            editPanel.style.display = 'none';
            addLog("åˆªé™¤", `ç§»é™¤äº† [${activeObj.customLabel}]`);
        }
    }

    // ==========================================
    // 5. æœå°‹åŠŸèƒ½ (åŒ…å«å‚™è¨»æœå°‹)
    // ==========================================
    function searchEvents() {
        const keyword = document.getElementById('searchInput').value.trim();
        const objects = canvas.getObjects();
        canvas.discardActiveObject();
        editPanel.style.display = 'none';

        if (keyword === "") {
            objects.forEach(obj => {
                obj.set('opacity', 1);
                if(obj.item(0)) {
                    obj.item(0).set('stroke', 'white');
                    obj.item(0).set('strokeWidth', 2);
                }
            });
        } else {
            objects.forEach(obj => {
                // æœå°‹åç¨± OR å‚™è¨»
                const matchLabel = obj.customLabel && obj.customLabel.includes(keyword);
                const matchNote = obj.customNote && obj.customNote.includes(keyword);

                if (matchLabel || matchNote) {
                    obj.set('opacity', 1);
                    if(obj.item(0)) {
                        obj.item(0).set('stroke', 'red');
                        obj.item(0).set('strokeWidth', 5);
                    }
                } else {
                    obj.set('opacity', 0.2);
                    if(obj.item(0)) {
                        obj.item(0).set('stroke', 'white');
                        obj.item(0).set('strokeWidth', 2);
                    }
                }
            });
        }
        canvas.requestRenderAll();
        renderLogs(keyword);
    }
    
    document.getElementById('searchInput').addEventListener('keyup', function(e){
        if(e.key === 'Enter') searchEvents();
    });

    // ==========================================
    // 6. å…¶ä»–åŸºç¤åŠŸèƒ½ (åŒ¯å…¥åœ–ç‰‡ã€ç´€éŒ„ã€å­˜æª”)
    // ==========================================
    
    // ç´€éŒ„åŠŸèƒ½
    function addLog(action, desc) {
        const time = new Date().toLocaleString();
        logData.push({ time, action, desc });
        renderLogs();
    }

    function renderLogs(filterText = "") {
        const list = document.getElementById('logList');
        list.innerHTML = "";
        const filtered = logData.filter(log => 
            filterText === "" || log.desc.includes(filterText)
        );

        if(filtered.length === 0) {
            list.innerHTML = '<p class="text-muted text-center mt-3">ç„¡ç›¸é—œç´€éŒ„</p>';
            return;
        }

        [...filtered].reverse().forEach(log => {
            const item = document.createElement('div');
            item.className = 'log-item';
            item.innerHTML = `
                <div class="d-flex justify-content-between">
                    <strong>${log.action}</strong>
                    <span class="log-time">${log.time}</span>
                </div>
                <div class="text-break">${log.desc}</div>
            `;
            list.appendChild(item);
        });
    }

    // åŒ¯å…¥åœ–ç‰‡
    document.getElementById('imgLoader').addEventListener('change', function (e) {
        const reader = new FileReader();
        reader.onload = function (event) {
            const imgObj = new Image();
            imgObj.src = event.target.result;
            imgObj.onload = function () {
                const imgInstance = new fabric.Image(imgObj);
                const maxWidth = document.querySelector('.canvas-area').clientWidth - 50;
                const scale = maxWidth / imgInstance.width;
                
                if (imgInstance.width > maxWidth) {
                    imgInstance.scale(scale);
                    canvas.setWidth(imgInstance.width * scale);
                    canvas.setHeight(imgInstance.height * scale);
                } else {
                    canvas.setWidth(imgInstance.width);
                    canvas.setHeight(imgInstance.height);
                }
                
                canvas.setBackgroundImage(imgInstance, canvas.renderAll.bind(canvas), {
                   scaleX: imgInstance.width > maxWidth ? scale : 1,
                   scaleY: imgInstance.width > maxWidth ? scale : 1
                });
                addLog("ç³»çµ±", "å·²åŒ¯å…¥å¹³é¢åœ–");
            }
        }
        reader.readAsDataURL(e.target.files[0]);
    });

    // å¦å­˜ç¶²é åŠŸèƒ½ (åŒ…å«å‚™è¨»æ¬„ä½)
    function saveSystem() {
        // é‡è¦ï¼šåœ¨ toJSON ä¸­åŠ å…¥ 'customNote' ä»¥ä¾¿å­˜æª”
        const canvasJson = JSON.stringify(canvas.toJSON(['customLabel', 'customType', 'customNote', 'timestamp']));
        
        const saveData = {
            canvas: canvasJson,
            logs: logData
        };

        let htmlContent = document.documentElement.outerHTML;
        const dataScriptPattern = /<script id="saved-data" type="application\/json">([\s\S]*?)<\/script>/;
        const newDataScript = `<script id="saved-data" type="application/json">${JSON.stringify(saveData)}<\/script>`;
        
        htmlContent = htmlContent.replace(dataScriptPattern, newDataScript);

        const blob = new Blob([htmlContent], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `å¹³é¢åœ–ç´€éŒ„_${new Date().toISOString().slice(0,10)}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        addLog("ç³»çµ±", "å·²åŒ¯å‡ºç¶²é æª”æ¡ˆ");
    }

    // è®€å–å­˜æª”
    window.onload = function() {
        const dataScript = document.getElementById('saved-data');
        if (dataScript && dataScript.textContent.trim() !== "") {
            try {
                const savedData = JSON.parse(dataScript.textContent);
                if(savedData.logs) {
                    logData = savedData.logs;
                    renderLogs();
                }
                if(savedData.canvas) {
                    canvas.loadFromJSON(savedData.canvas, function() {
                        canvas.renderAll();
                        addLog("ç³»çµ±", "å·²æˆåŠŸè®€å–èˆŠæª”ç´€éŒ„");
                    });
                }
            } catch (e) {
                console.error("è®€å–å­˜æª”å¤±æ•—", e);
            }
        }
    };
    
    // åˆªé™¤å¿«æ·éµ
    window.addEventListener('keydown', function(e) {
        if (e.key === 'Delete' || e.key === 'Backspace') {
            if(document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                deleteActiveObject();
            }
        }
    });

</script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>