<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹³é¢åœ–äº‹ä»¶ç´€éŒ„ç³»çµ± (å«è·¯ç·šå¼•å°åŠŸèƒ½)</title>
    <!-- å¼•å…¥ Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ FontAwesome åœ–ç¤ºåº« -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- å¼•å…¥ Fabric.js (è™•ç† Canvas) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <!-- å¼•å…¥ PDF ç›¸é—œå‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body { background-color: #f4f6f9; height: 100vh; overflow: hidden; font-family: "Microsoft JhengHei", sans-serif; }
        .main-container { height: 100%; display: flex; }
        .sidebar { width: 380px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; padding: 15px; overflow-y: auto; }
        .canvas-area { 
            flex-grow: 1; 
            background: #e9ecef; 
            position: relative; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: auto; 
            padding: 20px;
        }
        
        #canvas-wrapper { 
            box-shadow: 0 0 20px rgba(0,0,0,0.2); 
            background: white; 
        }

        .component-item {
            cursor: grab;
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            border-radius: 5px;
            background: #fff;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }
        .component-item:hover { background: #f8f9fa; border-color: #0d6efd; transform: translateX(5px); }
        .component-item i { font-size: 20px; margin-right: 10px; width: 30px; text-align: center; }
        
        .log-item { font-size: 0.9rem; border-bottom: 1px solid #eee; padding: 8px 0; }
        .log-time { color: #888; font-size: 0.8rem; }
        
        #edit-panel {
            background-color: #fff3cd;
            border: 1px solid #ffecb5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            margin-bottom: 15px;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 5px;
        }
        .form-check-label { font-size: 0.9rem; cursor: pointer; }
        .text-orange { color: #fd7e14 !important; }
        .text-dark-gray { color: #343a40 !important; }

        #pdf-temp-container {
            position: fixed;
            top: -9999px; left: -9999px; width: 800px;
            background: white; padding: 40px; border: 1px solid #000;
        }
        .pdf-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
        .pdf-info { margin-bottom: 20px; font-size: 0.9rem; color: #555; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.8rem; }
        .pdf-table th, .pdf-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .pdf-table th { background-color: #f2f2f2; }

        /* è·¯ç·šå¼•å°å°ˆç”¨æ¨£å¼ */
        .route-controls .btn { width: 100%; margin-bottom: 5px; }
        .blink-mode { animation: blinker 1.5s linear infinite; border: 2px solid red; }
        @keyframes blinker { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<div class="main-container">
    
    <!-- å·¦å´ï¼šå¹³é¢åœ–å€åŸŸ -->
    <div class="canvas-area" id="drop-area">
        <div id="canvas-wrapper">
            <canvas id="c" width="800" height="600"></canvas>
        </div>
        
        <div class="position-absolute top-0 start-0 m-3 d-flex gap-2 flex-wrap" style="max-width: 80%; z-index: 1000;">
            <label class="btn btn-primary shadow">
                <i class="fas fa-image me-2"></i>åŒ¯å…¥å¹³é¢åœ–
                <input type="file" id="imgLoader" style="display: none;" accept="image/*">
            </label>
            <label class="btn btn-secondary shadow">
                <i class="fas fa-file-import me-2"></i>åŒ¯å…¥å­˜æª”
                <input type="file" id="fileLoader" style="display: none;" accept=".html">
            </label>
            <button class="btn btn-success shadow" onclick="saveSystem()">
                <i class="fas fa-save me-2"></i>å„²å­˜ç¶²é 
            </button>
            <button class="btn btn-danger shadow" onclick="exportToPDF()">
                <i class="fas fa-file-pdf me-2"></i>åŒ¯å‡º PDF
            </button>
        </div>
        
        <!-- ç¹ªåœ–æ¨¡å¼æç¤º -->
        <div id="drawing-hint" class="position-absolute bottom-0 start-50 translate-middle-x mb-3 badge bg-danger fs-5 shadow" style="display: none;">
            <i class="fas fa-pen"></i> ç¹ªè£½æ¨¡å¼é–‹å•Ÿä¸­ï¼šè«‹é»æ“Šåœ°åœ–è¦åŠƒè·¯ç·š...
        </div>
    </div>

    <!-- å³å´ï¼šæ§åˆ¶èˆ‡ç´€éŒ„é¢æ¿ -->
    <div class="sidebar shadow-sm">
        <h5 class="border-bottom pb-2"><i class="fas fa-tools me-2"></i>æ“ä½œé¢æ¿</h5>
        
        <!-- å‹•æ…‹ç·¨è¼¯å€ -->
        <div id="edit-panel" class="shadow-sm">
            <h6 class="text-warning-emphasis fw-bold"><i class="fas fa-pen-to-square"></i> ç·¨è¼¯é¸å–é …ç›®</h6>
            <div class="mb-2">
                <label class="form-label mb-1">åç¨±/æ¨™ç±¤</label>
                <input type="text" class="form-control form-control-sm" id="editLabelInput">
            </div>
            
            <div class="row g-2 mb-2">
                <div class="col-6">
                    <label class="form-label mb-1">æ–‡å­—é¡è‰²</label>
                    <input type="color" class="form-control form-control-color w-100" id="editTextColor" value="#333333">
                </div>
                <div class="col-6">
                    <label class="form-label mb-1">æ–‡å­—ç²—ç´°</label>
                    <select class="form-select form-select-sm" id="editTextWeight">
                        <option value="bold">ç²—é«”</option>
                        <option value="normal">æ­£å¸¸</option>
                    </select>
                </div>
            </div>

            <div class="mb-2">
                <label class="form-label mb-1">è©³ç´°å‚™è¨»</label>
                <textarea class="form-control form-control-sm" id="editNoteInput" rows="3" placeholder="è«‹è¼¸å…¥å‚™è¨»..."></textarea>
            </div>
            <div class="d-flex justify-content-between">
                <button class="btn btn-sm btn-outline-danger" onclick="deleteActiveObject()">åˆªé™¤ç‰©ä»¶</button>
                <button class="btn btn-sm btn-dark" onclick="updateActiveObject()">æ›´æ–°è³‡æ–™</button>
            </div>
        </div>

        <!-- é¡¯ç¤ºç¯©é¸ -->
        <div class="filter-section">
            <h6 class="fw-bold mb-2"><i class="fas fa-filter"></i> é¡¯ç¤ºç¯©é¸</h6>
            <div class="filter-grid" id="visibilityControls">
                <div class="form-check">
                    <input class="form-check-input filter-cb" type="checkbox" value="fa-snowflake" checked id="cb-cool">
                    <label class="form-check-label" for="cb-cool"><i class="fas fa-snowflake text-success"></i> å†·æ°£</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input filter-cb" type="checkbox" value="fa-wind" checked id="cb-wind">
                    <label class="form-check-label" for="cb-wind"><i class="fas fa-wind text-orange"></i> é™¤æ¿•</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input filter-cb" type="checkbox" value="fa-droplet" checked id="cb-drop">
                    <label class="form-check-label" for="cb-drop"><i class="fas fa-droplet text-danger"></i> æ¼æ°´</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input filter-cb" type="checkbox" value="fa-bug" checked id="cb-bug">
                    <label class="form-check-label" for="cb-bug"><i class="fas fa-bug text-dark-gray"></i> é¼ æ‚£</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input filter-cb" type="checkbox" value="fa-triangle-exclamation" checked id="cb-warn">
                    <label class="form-check-label" for="cb-warn"><i class="fas fa-triangle-exclamation text-warning"></i> æ³¨æ„</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input filter-cb" type="checkbox" value="route" checked id="cb-route">
                    <label class="form-check-label" for="cb-route"><i class="fas fa-route text-primary"></i> è·¯ç·š</label>
                </div>
            </div>
        </div>

        <!-- æœå°‹ -->
        <div class="input-group mb-3">
            <input type="text" id="searchInput" class="form-control" placeholder="æœå°‹åç¨±...">
            <button class="btn btn-outline-secondary" type="button" onclick="searchEvents()"><i class="fas fa-search"></i></button>
        </div>

        <!-- é ç±¤ -->
        <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="components-tab" data-bs-toggle="tab" data-bs-target="#components" type="button">çµ„ä»¶åº«</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="route-tab" data-bs-toggle="tab" data-bs-target="#route" type="button">è·¯ç·šå¼•å°</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="custom-tab" data-bs-toggle="tab" data-bs-target="#custom" type="button">è‡ªå®šç¾©</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button">ç´€éŒ„</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- çµ„ä»¶åº« -->
            <div class="tab-pane fade show active" id="components">
                <div class="d-grid gap-2">
                    <div class="component-item" draggable="true" ondragstart="dragStart(event)" data-type="icon" data-icon="fa-snowflake" data-color="#198754" data-label="å†·æ°£æ©Ÿ">
                        <i class="fas fa-snowflake text-success"></i> å†·æ°£æ©Ÿ
                    </div>
                    <div class="component-item" draggable="true" ondragstart="dragStart(event)" data-type="icon" data-icon="fa-wind" data-color="#fd7e14" data-label="é™¤æ¿•æ©Ÿ">
                        <i class="fas fa-wind text-orange"></i> é™¤æ¿•æ©Ÿ
                    </div>
                    <div class="component-item" draggable="true" ondragstart="dragStart(event)" data-type="icon" data-icon="fa-droplet" data-color="#dc3545" data-label="æ¼æ°´é»">
                        <i class="fas fa-droplet text-danger"></i> æ¼æ°´ç™¼ç”Ÿé»
                    </div>
                    <div class="component-item" draggable="true" ondragstart="dragStart(event)" data-type="icon" data-icon="fa-bug" data-color="#343a40" data-label="é¼ æ‚£/èŸ²å®³">
                        <i class="fas fa-bug text-dark-gray"></i> é¼ æ‚£/èŸ²å®³ç´€éŒ„
                    </div>
                    <div class="component-item" draggable="true" ondragstart="dragStart(event)" data-type="icon" data-icon="fa-triangle-exclamation" data-color="#ffc107" data-label="æ³¨æ„å€åŸŸ">
                        <i class="fas fa-triangle-exclamation text-warning"></i> è­¦å‘Š/æ³¨æ„å€åŸŸ
                    </div>
                </div>
            </div>

            <!-- è·¯ç·šå¼•å°åŠŸèƒ½ (æ–°å¢) -->
            <div class="tab-pane fade" id="route">
                <div class="route-controls">
                    <div class="alert alert-info py-2" style="font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i> æ“ä½œèªªæ˜ï¼š<br>
                        1. é»æ“Šã€Œé–‹å§‹ç¹ªè£½ã€<br>
                        2. åœ¨åœ°åœ–ä¸Šä¾åºé»æ“Šè·¯å¾‘é»<br>
                        3. é»æ“Šã€ŒçµæŸç¹ªè£½ã€å®Œæˆ
                    </div>
                    
                    <button id="btnStartDraw" class="btn btn-outline-primary" onclick="startDrawingRoute()">
                        <i class="fas fa-pen"></i> é–‹å§‹ç¹ªè£½è·¯å¾‘
                    </button>
                    
                    <button id="btnStopDraw" class="btn btn-outline-success" onclick="stopDrawingRoute()" style="display:none;">
                        <i class="fas fa-check"></i> çµæŸç¹ªè£½
                    </button>
                    
                    <div class="d-flex gap-2 mt-2">
                        <button class="btn btn-warning" onclick="playRouteAnimation()">
                            <i class="fas fa-play"></i> æ’­æ”¾å°è¦½
                        </button>
                        <button class="btn btn-secondary" onclick="clearRoute()">
                            <i class="fas fa-trash"></i> æ¸…é™¤è·¯å¾‘
                        </button>
                    </div>
                    
                    <hr>
                    <label class="form-label">è·¯å¾‘æ¨£å¼</label>
                    <div class="d-flex gap-2 mb-2">
                        <input type="color" class="form-control form-control-color" id="routeColor" value="#0d6efd" title="è·¯å¾‘é¡è‰²">
                        <select class="form-select" id="routeWidth">
                            <option value="3">ç´°</option>
                            <option value="5" selected>ä¸­</option>
                            <option value="8">ç²—</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- è‡ªå®šç¾© -->
            <div class="tab-pane fade" id="custom">
                <!-- è‡ªå®šç¾©è¡¨å–®å…§å®¹ (ä¿æŒä¸è®Š) -->
                <div class="mb-2">
                    <label class="form-label">äº‹ä»¶åç¨±</label>
                    <input type="text" class="form-control" id="customLabel" placeholder="ä¾‹å¦‚ï¼š202æœƒè­°å®¤">
                </div>
                <div class="mb-2">
                    <label class="form-label">é¸æ“‡åœ–ç¤º</label>
                    <select class="form-select" id="customIcon">
                        <option value="fa-circle-exclamation">â— é©šå˜†è™Ÿ</option>
                        <option value="fa-wrench">ğŸ”§ ç¶­ä¿®</option>
                        <option value="fa-fire">ğŸ”¥ ç«æº</option>
                        <option value="fa-camera">ğŸ“· ç›£è¦–å™¨</option>
                        <option value="fa-comment-dots">ğŸ’¬ æ–‡å­—è¨»è¨˜</option>
                    </select>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-4">
                        <label class="form-label mb-1" style="font-size:0.8rem">åœ–ç¤ºé¡è‰²</label>
                        <input type="color" class="form-control form-control-color w-100" id="customColor" value="#ff0000">
                    </div>
                    <div class="col-4">
                        <label class="form-label mb-1" style="font-size:0.8rem">æ–‡å­—é¡è‰²</label>
                        <input type="color" class="form-control form-control-color w-100" id="customTextColor" value="#333333">
                    </div>
                    <div class="col-4">
                        <label class="form-label mb-1" style="font-size:0.8rem">æ–‡å­—ç²—ç´°</label>
                        <select class="form-select form-select-sm" id="customTextWeight">
                            <option value="bold" selected>ç²—é«”</option>
                            <option value="normal">æ­£å¸¸</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">é è¨­å‚™è¨»</label>
                    <textarea class="form-control" id="customNote" rows="2" placeholder="å¯åœ¨æ­¤å…ˆè¼¸å…¥å‚™è¨»å…§å®¹"></textarea>
                </div>
                <button class="btn btn-dark w-100" onclick="addCustomComponent()">æ–°å¢è‡³ç•«é¢</button>
            </div>

            <!-- ç´€éŒ„ -->
            <div class="tab-pane fade" id="logs">
                <div id="logList">
                    <p class="text-muted text-center mt-3">æš«ç„¡ç·¨è¼¯ç´€éŒ„</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="pdf-temp-container"></div>
<script id="saved-data" type="application/json"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        const canvas = new fabric.Canvas('c', { selection: true });
        let logData = []; 
        const STANDARD_TYPES = ['fa-snowflake', 'fa-wind', 'fa-droplet', 'fa-bug', 'fa-triangle-exclamation'];
        
        // è·¯ç·šç›¸é—œè®Šæ•¸
        let isDrawingRoute = false;
        let routePoints = [];
        let activeRouteLine = null;
        let guideMarker = null;

        // ==========================================
        // 1. è·¯ç·šå¼•å°æ ¸å¿ƒé‚è¼¯ (æ–°å¢)
        // ==========================================
        window.startDrawingRoute = function() {
            if (!canvas.backgroundImage) {
                alert("è«‹å…ˆåŒ¯å…¥å¹³é¢åœ–æ‰èƒ½ç¹ªè£½è·¯å¾‘ï¼");
                return;
            }
            isDrawingRoute = true;
            routePoints = [];
            
            // UI åˆ‡æ›
            document.getElementById('btnStartDraw').style.display = 'none';
            document.getElementById('btnStopDraw').style.display = 'inline-block';
            document.getElementById('drawing-hint').style.display = 'block';
            
            // é–å®šå…¶ä»–ç‰©ä»¶é¿å…èª¤è§¸
            canvas.getObjects().forEach(obj => obj.selectable = false);
            canvas.defaultCursor = 'crosshair';
            
            addLog("è·¯ç·š", "é–‹å§‹ç¹ªè£½å°è¦½è·¯å¾‘");
        }

        window.stopDrawingRoute = function() {
            isDrawingRoute = false;
            
            // UI åˆ‡æ›
            document.getElementById('btnStartDraw').style.display = 'inline-block';
            document.getElementById('btnStopDraw').style.display = 'none';
            document.getElementById('drawing-hint').style.display = 'none';
            
            // è§£é–ç‰©ä»¶
            canvas.getObjects().forEach(obj => {
                // è·¯å¾‘ç·šæœ¬èº«ä¸çµ¦é¸ï¼Œé¿å…èª¤ç§»
                if(obj.customType !== 'route') obj.selectable = true;
            });
            canvas.defaultCursor = 'default';
            
            addLog("è·¯ç·š", "å®Œæˆè·¯å¾‘ç¹ªè£½");
        }

        window.clearRoute = function() {
            // æ¸…é™¤ç¾æœ‰çš„è·¯ç·šå’Œæ¨™è¨˜
            const objects = canvas.getObjects();
            objects.forEach(obj => {
                if (obj.customType === 'route' || obj.id === 'guideMarker') {
                    canvas.remove(obj);
                }
            });
            activeRouteLine = null;
            routePoints = [];
            canvas.requestRenderAll();
            addLog("è·¯ç·š", "æ¸…é™¤è·¯å¾‘");
        }

        // ç›£è½ç•«å¸ƒé»æ“Š (ç¹ªè£½è·¯ç·šç”¨)
        canvas.on('mouse:down', function(opt) {
            if (!isDrawingRoute) return;

            const pointer = canvas.getPointer(opt.e);
            routePoints.push({ x: pointer.x, y: pointer.y });

            // ç¹ªè£½æˆ–æ›´æ–°ç·šæ¢
            const color = document.getElementById('routeColor').value;
            const width = parseInt(document.getElementById('routeWidth').value);

            if (routePoints.length > 1) {
                // ç§»é™¤èˆŠç·š
                if (activeRouteLine) canvas.remove(activeRouteLine);

                // ç¹ªè£½æ–°ç·š
                activeRouteLine = new fabric.Polyline(routePoints, {
                    stroke: color,
                    strokeWidth: width,
                    strokeDashArray: [10, 5], // è™›ç·šæ•ˆæœ
                    fill: 'transparent',
                    selectable: false,
                    evented: false,
                    originX: 'left',
                    originY: 'top'
                });
                
                activeRouteLine.customType = 'route'; // æ¨™è¨˜ç‚ºè·¯ç·š
                canvas.add(activeRouteLine);
                canvas.renderAll();
            } else {
                // ç¬¬ä¸€å€‹é»ï¼Œç•«å€‹å°åœ“æç¤ºèµ·é»
                const startDot = new fabric.Circle({
                    left: pointer.x, top: pointer.y,
                    radius: width, fill: color,
                    originX: 'center', originY: 'center',
                    selectable: false,
                    id: 'guideMarker' // æš«æ™‚æ¨™è¨˜ï¼Œæ¸…é™¤æ™‚ä¸€èµ·æ¸…
                });
                canvas.add(startDot);
            }
        });

        // è·¯ç·šå‹•ç•«æ’­æ”¾
        window.playRouteAnimation = function() {
            if (!activeRouteLine || routePoints.length < 2) {
                alert("è«‹å…ˆç¹ªè£½è·¯å¾‘ï¼");
                return;
            }

            // å¦‚æœå·²æœ‰æ¨™è¨˜åœ¨è·‘ï¼Œå…ˆç§»é™¤
            if (guideMarker) canvas.remove(guideMarker);

            // å»ºç«‹å°è¦½æ¨™è¨˜ (ä¸€å€‹é¡¯çœ¼çš„å…‰é»)
            guideMarker = new fabric.Circle({
                radius: 8,
                fill: '#ff0000',
                stroke: '#fff',
                strokeWidth: 2,
                originX: 'center',
                originY: 'center',
                left: routePoints[0].x,
                top: routePoints[0].y,
                selectable: false,
                evented: false,
                id: 'guideMarker'
            });
            
            // åŠ å…¥ç™¼å…‰æ•ˆæœ
            guideMarker.set('shadow', new fabric.Shadow({ color: 'rgba(255,0,0,0.8)', blur: 10 }));
            
            canvas.add(guideMarker);
            
            // éè¿´åŸ·è¡Œå‹•ç•«
            function animateSegment(index) {
                if (index >= routePoints.length - 1) {
                    // å‹•ç•«çµæŸï¼Œç§»é™¤æ¨™è¨˜æˆ–åœåœ¨çµ‚é»
                    // canvas.remove(guideMarker); 
                    return;
                }

                const start = routePoints[index];
                const end = routePoints[index+1];
                
                // è¨ˆç®—è·é›¢ä»¥æ±ºå®šé€Ÿåº¦ (ä¿æŒç­‰é€Ÿ)
                const distance = Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2));
                const duration = distance * 5; // é€Ÿåº¦ä¿‚æ•¸ï¼Œæ•¸å­—è¶Šå¤§è¶Šæ…¢

                guideMarker.animate({
                    left: end.x,
                    top: end.y
                }, {
                    duration: duration,
                    onChange: canvas.renderAll.bind(canvas),
                    onComplete: function() {
                        animateSegment(index + 1);
                    },
                    easing: fabric.util.ease.linear
                });
            }

            animateSegment(0);
            addLog("è·¯ç·š", "æ’­æ”¾è·¯å¾‘å°è¦½");
        }

        // ==========================================
        // 2. åœ–ç‰‡åŒ¯å…¥èˆ‡æª”æ¡ˆåŒ¯å…¥ (ç¶­æŒè‡ªå‹•é©æ‡‰é‚è¼¯)
        // ==========================================
        const imgLoader = document.getElementById('imgLoader');
        if (imgLoader) {
            imgLoader.addEventListener('change', function (e) {
                if (!e.target.files[0]) return; 
                const reader = new FileReader();
                reader.onload = function (event) {
                    const imgObj = new Image();
                    imgObj.src = event.target.result;
                    imgObj.onload = function () {
                        const area = document.querySelector('.canvas-area');
                        const padding = 40;
                        const availableWidth = area.clientWidth - padding;
                        const availableHeight = area.clientHeight - padding;
                        const scaleW = availableWidth / imgObj.width;
                        const scaleH = availableHeight / imgObj.height;
                        let scale = Math.min(scaleW, scaleH);
                        if (!isFinite(scale) || scale <= 0) scale = 1;

                        const imgInstance = new fabric.Image(imgObj, {
                            scaleX: scale, scaleY: scale, originX: 'left', originY: 'top'
                        });

                        canvas.setWidth(imgObj.width * scale);
                        canvas.setHeight(imgObj.height * scale);
                        canvas.setBackgroundImage(imgInstance, canvas.renderAll.bind(canvas));
                        
                        // åˆ‡æ›åœ–ç‰‡æ™‚æ¸…é™¤èˆŠè·¯ç·š
                        clearRoute();
                        addLog("ç³»çµ±", "å·²åŒ¯å…¥å¹³é¢åœ–");
                    }
                }
                reader.readAsDataURL(e.target.files[0]);
                e.target.value = ''; 
            });
        }

        const fileLoader = document.getElementById('fileLoader');
        if (fileLoader) {
            fileLoader.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(event) {
                    const text = event.target.result;
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/html');
                    const scriptTag = doc.getElementById('saved-data');

                    if (scriptTag && scriptTag.textContent.trim() !== "") {
                        try {
                            const savedData = JSON.parse(scriptTag.textContent);
                            if(savedData.logs) { logData = savedData.logs; renderLogs(); }
                            if(savedData.canvas) {
                                canvas.loadFromJSON(savedData.canvas, function() {
                                    if (canvas.backgroundImage) {
                                        const bg = canvas.backgroundImage;
                                        canvas.setWidth(bg.width * bg.scaleX);
                                        canvas.setHeight(bg.height * bg.scaleY);
                                    }
                                    
                                    // å˜—è©¦æ¢å¾©è·¯ç·šçš„é»ä½è³‡æ–™ (å¦‚æœå­˜æª”æœ‰åŒ…å«)
                                    // æ³¨æ„ï¼šFabric loadFromJSON æœƒè‡ªå‹•æ¢å¾© Polyline ç‰©ä»¶ï¼Œä½† routePoints é™£åˆ—éœ€è¦é‡æ–°æŠ“å–
                                    const objects = canvas.getObjects();
                                    objects.forEach(obj => {
                                        if (obj.customType === 'route' && obj.points) {
                                            activeRouteLine = obj;
                                            // è½‰æ›é»ä½åº§æ¨™å›çµ•å°åº§æ¨™ (å› ç‚º Polyline å…§éƒ¨æ˜¯ç›¸å°çš„)
                                            // é€™è£¡ç°¡åŒ–è™•ç†ï¼šç›´æ¥è®“ä½¿ç”¨è€…é‡æ–°ç•«ï¼Œæˆ–è€…åªä½œç‚ºéœæ…‹é¡¯ç¤º
                                            // è‹¥è¦æ”¯æ´ç·¨è¼¯èˆŠè·¯ç·šè¼ƒè¤‡é›œï¼Œé€™è£¡åƒ…æ”¯æ´"é¡¯ç¤º"å­˜æª”çš„è·¯ç·š
                                            obj.selectable = false;
                                        }
                                    });
                                    
                                    canvas.renderAll();
                                    addLog("ç³»çµ±", "å·²æˆåŠŸè®€å–å¤–éƒ¨å­˜æª”");
                                });
                            }
                        } catch (err) { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
                    }
                };
                reader.readAsText(file);
                e.target.value = ''; 
            });
        }

        // ==========================================
        // 3. å…¶ä»–åŸºç¤åŠŸèƒ½ (ç¯©é¸ã€æ‹–æ›³ã€ç·¨è¼¯ã€PDF)
        // ==========================================
        document.querySelectorAll('.filter-cb').forEach(cb => {
            cb.addEventListener('change', updateVisibility);
        });

        function updateVisibility() {
            const checkedValues = Array.from(document.querySelectorAll('.filter-cb:checked')).map(cb => cb.value);
            const objects = canvas.getObjects();
            objects.forEach(obj => {
                const type = obj.customType;
                if (STANDARD_TYPES.includes(type)) {
                    obj.visible = checkedValues.includes(type);
                } else if (type === 'route') {
                    obj.visible = checkedValues.includes('route');
                } else {
                    obj.visible = checkedValues.includes('other');
                }
            });
            canvas.discardActiveObject(); 
            canvas.requestRenderAll();
        }

        window.dragStart = function(e) {
            e.dataTransfer.setData('icon', e.target.dataset.icon);
            e.dataTransfer.setData('color', e.target.dataset.color);
            e.dataTransfer.setData('label', e.target.dataset.label);
        }

        const dropArea = document.getElementById('drop-area');
        dropArea.addEventListener('dragover', (e) => { e.preventDefault(); });
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            const iconClass = e.dataTransfer.getData('icon');
            const color = e.dataTransfer.getData('color');
            const label = e.dataTransfer.getData('label');
            if (iconClass) {
                const pointer = canvas.getPointer(e);
                addComponentToCanvas(iconClass, color, label, pointer.x, pointer.y, "", "#333333", "bold");
            }
        });

        function addComponentToCanvas(iconClass, color, labelText, left, top, noteContent = "", textColor = "#333333", fontWeight = "bold") {
            const circle = new fabric.Circle({ radius: 15, fill: color, originX: 'center', originY: 'center', stroke: 'white', strokeWidth: 2 });
            const text = new fabric.Text(labelText, { fontSize: 18, originX: 'center', originY: 'top', top: 20, fill: textColor, fontWeight: fontWeight, fontFamily: 'Microsoft JhengHei' });
            const group = new fabric.Group([circle, text], { left: left, top: top, hasBorders: true, hasControls: true });
            group.customLabel = labelText;
            group.customType = iconClass;
            group.customNote = noteContent;
            group.timestamp = new Date().toLocaleString();
            canvas.add(group);
            canvas.setActiveObject(group);
            addLog("æ–°å¢", `æ·»åŠ äº† [${labelText}]`);
        }

        window.addCustomComponent = function() {
            const label = document.getElementById('customLabel').value || "è‡ªå®šç¾©æ¨™è¨˜";
            const icon = document.getElementById('customIcon').value;
            const color = document.getElementById('customColor').value;
            const note = document.getElementById('customNote').value;
            const textColor = document.getElementById('customTextColor').value;
            const textWeight = document.getElementById('customTextWeight').value;
            addComponentToCanvas(icon, color, label, canvas.width / 2, canvas.height / 2, note, textColor, textWeight);
            document.getElementById('customLabel').value = ""; document.getElementById('customNote').value = "";
        }

        // ç·¨è¼¯ç›¸é—œ
        const editPanel = document.getElementById('edit-panel');
        const editLabelInput = document.getElementById('editLabelInput');
        const editNoteInput = document.getElementById('editNoteInput');
        const editTextColor = document.getElementById('editTextColor');
        const editTextWeight = document.getElementById('editTextWeight');

        function onSelectionCreated() {
            const activeObj = canvas.getActiveObject();
            if (activeObj && activeObj.type === 'group' && activeObj.visible) {
                editLabelInput.value = activeObj.customLabel || "";
                editNoteInput.value = activeObj.customNote || "";
                if (activeObj.item(1)) {
                    editTextColor.value = activeObj.item(1).fill || "#333333";
                    editTextWeight.value = activeObj.item(1).fontWeight || "bold";
                }
                editPanel.style.display = 'block';
            } else { editPanel.style.display = 'none'; }
        }
        function onSelectionCleared() { editPanel.style.display = 'none'; }
        canvas.on('selection:created', onSelectionCreated);
        canvas.on('selection:updated', onSelectionCreated);
        canvas.on('selection:cleared', onSelectionCleared);

        window.updateActiveObject = function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                activeObj.customLabel = editLabelInput.value;
                activeObj.customNote = editNoteInput.value;
                if (activeObj.item(1)) {
                    activeObj.item(1).set('text', editLabelInput.value);
                    activeObj.item(1).set('fill', editTextColor.value);
                    activeObj.item(1).set('fontWeight', editTextWeight.value);
                }
                canvas.requestRenderAll();
                addLog("æ›´æ–°", `æ›´æ–°è³‡æ–™`);
            }
        }

        window.deleteActiveObject = function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                canvas.remove(activeObj);
                canvas.discardActiveObject();
                editPanel.style.display = 'none';
                addLog("åˆªé™¤", `ç§»é™¤ç‰©ä»¶`);
            }
        }
        
        window.addEventListener('keydown', function(e) {
            if (e.key === 'Delete' || e.key === 'Backspace') {
                if(document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') deleteActiveObject();
            }
        });

        window.exportToPDF = async function() {
            const { jsPDF } = window.jspdf;
            const container = document.getElementById('pdf-temp-container');
            
            // æ¸…é™¤é¸å–ä¸¦æ¸²æŸ“ï¼Œç¢ºä¿æˆªåœ–ä¹¾æ·¨
            canvas.discardActiveObject();
            if (guideMarker) canvas.remove(guideMarker); // åŒ¯å‡ºæ™‚ç§»é™¤ç´…è‰²å°è¦½é»
            canvas.requestRenderAll();
            
            const canvasImgData = canvas.toDataURL({ format: 'png', multiplier: 2 });
            let logTableRows = logData.map((log, i) => `<tr><td>${i+1}</td><td>${log.time}</td><td>${log.action}</td><td>${log.desc}</td></tr>`).join('');

            container.innerHTML = `
                <div class="pdf-header"><h1>å¹³é¢åœ–äº‹ä»¶ç´€éŒ„å ±å‘Š</h1></div>
                <div class="pdf-info"><p><strong>åŒ¯å‡ºæ™‚é–“ï¼š</strong>${new Date().toLocaleString()}</p></div>
                <div style="text-align:center; margin-bottom: 20px; border: 1px solid #ccc;"><img src="${canvasImgData}" style="max-width: 100%;"></div>
                <h3>ç´€éŒ„æ˜ç´°</h3>
                <table class="pdf-table"><thead><tr><th width="5%">#</th><th width="20%">æ™‚é–“</th><th width="10%">å‹•ä½œ</th><th>èªªæ˜</th></tr></thead><tbody>${logTableRows}</tbody></table>
            `;

            try {
                addLog("ç³»çµ±", "æ­£åœ¨ç”Ÿæˆ PDF...");
                const canvasEl = await html2canvas(container, { scale: 2 });
                const imgData = canvasEl.toDataURL('image/jpeg', 0.9);
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgHeight = (pdf.getImageProperties(imgData).height * pdfWidth) / pdf.getImageProperties(imgData).width;
                pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, imgHeight);
                pdf.save(`å¹³é¢åœ–å ±å‘Š_${new Date().toISOString().slice(0,10)}.pdf`);
                addLog("ç³»çµ±", "PDF åŒ¯å‡ºå®Œæˆ");
            } catch (error) { console.error(error); alert("PDF ç”Ÿæˆå¤±æ•—"); } 
            finally { container.innerHTML = ''; }
        }

        window.searchEvents = function() {
            const keyword = document.getElementById('searchInput').value.trim();
            const objects = canvas.getObjects();
            canvas.discardActiveObject();
            editPanel.style.display = 'none';
            objects.forEach(obj => {
                if (!obj.visible) return;
                if (keyword === "") {
                    obj.set('opacity', 1);
                    if(obj.item && obj.item(0)) { obj.item(0).set('stroke', 'white'); obj.item(0).set('strokeWidth', 2); }
                } else {
                    const match = (obj.customLabel && obj.customLabel.includes(keyword)) || (obj.customNote && obj.customNote.includes(keyword));
                    if (match) {
                        obj.set('opacity', 1);
                        if(obj.item && obj.item(0)) { obj.item(0).set('stroke', 'red'); obj.item(0).set('strokeWidth', 5); }
                    } else {
                        obj.set('opacity', 0.2);
                        if(obj.item && obj.item(0)) { obj.item(0).set('stroke', 'white'); obj.item(0).set('strokeWidth', 2); }
                    }
                }
            });
            canvas.requestRenderAll();
        }
        document.getElementById('searchInput').addEventListener('keyup', e => { if(e.key === 'Enter') searchEvents(); });

        function addLog(action, desc) {
            logData.push({ time: new Date().toLocaleString(), action, desc });
            renderLogs();
        }
        function renderLogs() {
            const list = document.getElementById('logList');
            if(logData.length === 0) { list.innerHTML = '<p class="text-muted text-center mt-3">ç„¡ç›¸é—œç´€éŒ„</p>'; return; }
            list.innerHTML = logData.slice().reverse().map(log => `<div class="log-item"><div class="d-flex justify-content-between"><strong>${log.action}</strong><span class="log-time">${log.time}</span></div><div class="text-break">${log.desc}</div></div>`).join('');
        }

        window.saveSystem = function() {
            const canvasJson = JSON.stringify(canvas.toJSON(['customLabel', 'customType', 'customNote', 'timestamp']));
            const saveData = { canvas: canvasJson, logs: logData };
            let htmlContent = document.documentElement.outerHTML;
            const dataScriptPattern = /<script id="saved-data" type="application\/json">([\s\S]*?)<\/script>/;
            const newDataScript = `<script id="saved-data" type="application/json">${JSON.stringify(saveData)}<\/script>`;
            htmlContent = htmlContent.replace(dataScriptPattern, newDataScript);
            const blob = new Blob([htmlContent], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å¹³é¢åœ–ç´€éŒ„_${new Date().toISOString().slice(0,10)}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            addLog("ç³»çµ±", "å·²åŒ¯å‡ºç¶²é æª”æ¡ˆ");
        }

        // è‡ªå‹•è®€å–å­˜æª”
        const dataScript = document.getElementById('saved-data');
        if (dataScript && dataScript.textContent.trim() !== "") {
            try {
                const savedData = JSON.parse(dataScript.textContent);
                if(savedData.logs) { logData = savedData.logs; renderLogs(); }
                if(savedData.canvas) {
                    canvas.loadFromJSON(savedData.canvas, function() {
                        if (canvas.backgroundImage) {
                            const bg = canvas.backgroundImage;
                            canvas.setWidth(bg.width * bg.scaleX);
                            canvas.setHeight(bg.height * bg.scaleY);
                        }
                        canvas.renderAll();
                        addLog("ç³»çµ±", "å·²æˆåŠŸè®€å–èˆŠæª”ç´€éŒ„");
                    });
                }
            } catch (e) {}
        }
    });
</script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>